<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SeiMoney Frontend Test Runner - Comprehensive</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #eee;
        }
        .infrastructure-status {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        .test-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        .test-button {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            background: #007bff;
            color: white;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .test-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .test-button.secondary {
            background: #6c757d;
        }
        .test-button.secondary:hover {
            background: #545b62;
        }
        .results-container {
            margin-top: 20px;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            border-left: 4px solid;
        }
        .test-result.passed {
            background: #d4edda;
            border-color: #28a745;
        }
        .test-result.failed {
            background: #f8d7da;
            border-color: #dc3545;
        }
        .test-result.warning {
            background: #fff3cd;
            border-color: #ffc107;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-indicator.online {
            background: #28a745;
        }
        .status-indicator.offline {
            background: #dc3545;
        }
        .status-indicator.unknown {
            background: #ffc107;
        }
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: #007bff;
            transition: width 0.3s ease;
        }
        .screenshot-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .screenshot-item {
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
        }
        .screenshot-item img {
            width: 100%;
            height: auto;
        }
        .screenshot-item .caption {
            padding: 8px;
            background: #f8f9fa;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üß™ SeiMoney Frontend Test Runner</h1>
            <p>Comprehensive testing suite for all frontend components and integrations</p>
            <div class="infrastructure-status" id="infrastructure-status">
                <h4>üîß Infrastructure Status</h4>
                <div id="status-indicators">
                    <div><span class="status-indicator unknown" id="api-status"></span> API Connectivity</div>
                    <div><span class="status-indicator unknown" id="wallet-status"></span> Wallet Availability</div>
                    <div><span class="status-indicator unknown" id="screenshot-status"></span> Screenshot Capture</div>
                    <div><span class="status-indicator unknown" id="data-status"></span> Data Management</div>
                </div>
            </div>
        </div>

        <div class="test-controls">
            <button class="test-button" onclick="initializeInfrastructure()">üöÄ Initialize Infrastructure</button>
            <button class="test-button" onclick="runFullSuite()">üß™ Run Full Test Suite</button>
            <button class="test-button" onclick="testScreen('home')">üè† Test Home Screen</button>
            <button class="test-button" onclick="testScreen('dashboard')">üìä Test Dashboard</button>
            <button class="test-button" onclick="testScreen('payments')">üí∏ Test Payments</button>
            <button class="test-button" onclick="testScreen('ai-agent')">ü§ñ Test AI Agent</button>
            <button class="test-button" onclick="testIntegration('api')">üåê Test API Integration</button>
            <button class="test-button" onclick="testIntegration('wallet')">üëõ Test Wallet Integration</button>
            <button class="test-button secondary" onclick="captureScreenshots()">üì∏ Capture Screenshots</button>
            <button class="test-button secondary" onclick="performHealthCheck()">üîç Health Check</button>
            <button class="test-button secondary" onclick="viewTestData()">üìä View Test Data</button>
            <button class="test-button secondary" onclick="clearTestData()">üóëÔ∏è Clear Test Data</button>
        </div>

        <div id="results-container" class="results-container">
            <div class="loading">
                <p>üéØ Ready to test! Click "Initialize Infrastructure" to get started.</p>
                <p><em>Make sure you're on the SeiMoney application page for tests to work properly</em></p>
            </div>
        </div>
    </div>

    <script>
        let isTestRunning = false;
        let infrastructureInitialized = false;

        // Initialize status indicators
        updateStatusIndicators();

        async function initializeInfrastructure() {
            if (isTestRunning) return;
            
            setTestRunning(true);
            showLoading('Initializing test infrastructure...');
            
            try {
                if (!window.SeiMoneyTesting) {
                    throw new Error('SeiMoney Testing Suite not available. Make sure you\'re on the application page.');
                }
                
                const infrastructure = await window.SeiMoneyTesting.testInfrastructure();
                const status = await infrastructure.initialize();
                
                infrastructureInitialized = status.initialized;
                displayInfrastructureInitialization(status);
                updateStatusIndicators();
                
            } catch (error) {
                displayError('Failed to initialize infrastructure', error);
            } finally {
                setTestRunning(false);
            }
        }

        async function runFullSuite() {
            if (isTestRunning) return;
            
            if (!infrastructureInitialized) {
                alert('Please initialize infrastructure first');
                return;
            }
            
            setTestRunning(true);
            showLoading('Running comprehensive test suite...');
            
            try {
                const result = await window.SeiMoneyTesting.runFullTestSuite();
                displayTestSuite(result);
            } catch (error) {
                displayError('Failed to run test suite', error);
            } finally {
                setTestRunning(false);
            }
        }

        async function testScreen(screenName) {
            if (isTestRunning) return;
            
            setTestRunning(true);
            showLoading(`Testing ${screenName} screen...`);
            
            try {
                const results = await window.SeiMoneyTesting.testScreen(screenName);
                displayTestResults(results, `${screenName} Screen Tests`);
            } catch (error) {
                displayError(`Failed to test ${screenName} screen`, error);
            } finally {
                setTestRunning(false);
            }
        }

        async function testIntegration(integrationType) {
            if (isTestRunning) return;
            
            setTestRunning(true);
            showLoading(`Testing ${integrationType} integration...`);
            
            try {
                const results = await window.SeiMoneyTesting.testIntegration(integrationType);
                displayTestResults(results, `${integrationType} Integration Tests`);
            } catch (error) {
                displayError(`Failed to test ${integrationType} integration`, error);
            } finally {
                setTestRunning(false);
            }
        }

        async function captureScreenshots() {
            if (isTestRunning) return;
            
            setTestRunning(true);
            showLoading('Capturing screenshots...');
            
            try {
                const screenshotCapture = await window.SeiMoneyTesting.screenshotCapture();
                
                // Capture multiple screenshots
                const screenshots = [];
                
                // Full page screenshot
                const fullPage = await screenshotCapture.captureFullPage();
                screenshots.push({ name: 'Full Page', image: fullPage, timestamp: new Date() });
                
                // Try to capture specific elements if they exist
                const elements = [
                    { selector: 'nav', name: 'Navigation' },
                    { selector: 'main', name: 'Main Content' },
                    { selector: 'footer', name: 'Footer' }
                ];
                
                for (const element of elements) {
                    try {
                        const screenshot = await screenshotCapture.captureElement(element.selector);
                        screenshots.push({ name: element.name, image: screenshot, timestamp: new Date() });
                    } catch (error) {
                        console.warn(`Failed to capture ${element.name}:`, error);
                    }
                }
                
                displayScreenshots(screenshots);
                
            } catch (error) {
                displayError('Failed to capture screenshots', error);
            } finally {
                setTestRunning(false);
            }
        }

        async function performHealthCheck() {
            if (isTestRunning) return;
            
            setTestRunning(true);
            showLoading('Performing health check...');
            
            try {
                const infrastructure = await window.SeiMoneyTesting.testInfrastructure();
                const healthCheck = await infrastructure.performHealthCheck();
                const status = infrastructure.getStatus();
                
                displayHealthCheck(healthCheck, status);
                updateStatusIndicators();
                
            } catch (error) {
                displayError('Failed to perform health check', error);
            } finally {
                setTestRunning(false);
            }
        }

        async function viewTestData() {
            if (isTestRunning) return;
            
            setTestRunning(true);
            showLoading('Loading test data...');
            
            try {
                const dataManager = await window.SeiMoneyTesting.testDataManager();
                const statistics = dataManager.getDataStatistics();
                const testSuites = dataManager.getAllTestSuites();
                const snapshots = dataManager.getAllSnapshots();
                
                displayTestData(statistics, testSuites, snapshots);
                
            } catch (error) {
                displayError('Failed to load test data', error);
            } finally {
                setTestRunning(false);
            }
        }

        async function clearTestData() {
            if (isTestRunning) return;
            
            if (!confirm('Are you sure you want to clear all test data? This action cannot be undone.')) return;
            
            setTestRunning(true);
            showLoading('Clearing test data...');
            
            try {
                const dataManager = await window.SeiMoneyTesting.testDataManager();
                const infrastructure = await window.SeiMoneyTesting.testInfrastructure();
                
                await dataManager.executeAllCleanupTasks();
                await infrastructure.cleanup();
                
                const container = document.getElementById('results-container');
                container.innerHTML = `
                    <div class="test-result passed">
                        <h3>üóëÔ∏è Test Data Cleared</h3>
                        <p>All test data has been cleared successfully</p>
                        <p>Infrastructure cleanup completed</p>
                    </div>
                `;
                
                updateStatusIndicators();
                
            } catch (error) {
                displayError('Failed to clear test data', error);
            } finally {
                setTestRunning(false);
            }
        }

        function setTestRunning(running) {
            isTestRunning = running;
            const buttons = document.querySelectorAll('.test-button');
            buttons.forEach(button => {
                button.disabled = running;
            });
        }

        function showLoading(message) {
            const container = document.getElementById('results-container');
            container.innerHTML = `
                <div class="loading">
                    <p>‚è≥ ${message}</p>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: 0%; animation: progress 2s ease-in-out infinite;"></div>
                    </div>
                </div>
                <style>
                    @keyframes progress {
                        0% { width: 0%; }
                        50% { width: 70%; }
                        100% { width: 100%; }
                    }
                </style>
            `;
        }

        function displayInfrastructureInitialization(status) {
            const container = document.getElementById('results-container');
            
            let html = `
                <h3>üöÄ Infrastructure Initialization</h3>
                <div class="test-result ${status.initialized ? 'passed' : 'failed'}">
                    <strong>Overall Status:</strong> ${status.initialized ? 'Initialized Successfully' : 'Initialization Failed'}
                </div>
            `;
            
            // Display component status
            const components = [
                { key: 'screenshotCapture', name: 'Screenshot Capture', icon: 'üì∏' },
                { key: 'dataManagement', name: 'Data Management', icon: 'üíæ' },
                { key: 'environmentDetection', name: 'Environment Detection', icon: 'üåç' },
                { key: 'apiConnectivity', name: 'API Connectivity', icon: 'üåê' }
            ];
            
            components.forEach(component => {
                const value = status[component.key];
                html += `
                    <div class="test-result ${value ? 'passed' : 'warning'}">
                        <strong>${component.icon} ${component.name}</strong>
                        <p>${value ? 'Available' : 'Not Available'}</p>
                    </div>
                `;
            });
            
            // Display wallet availability
            if (status.walletAvailability) {
                Object.entries(status.walletAvailability).forEach(([wallet, available]) => {
                    html += `
                        <div class="test-result ${available ? 'passed' : 'warning'}">
                            <strong>üëõ ${wallet.charAt(0).toUpperCase() + wallet.slice(1)} Wallet</strong>
                            <p>${available ? 'Available' : 'Not Detected'}</p>
                        </div>
                    `;
                });
            }
            
            // Display errors if any
            if (status.errors && status.errors.length > 0) {
                html += `
                    <div class="test-result failed">
                        <strong>‚ö†Ô∏è Issues</strong>
                        <pre>${status.errors.join('\\n')}</pre>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }

        function displayTestSuite(testSuite) {
            const container = document.getElementById('results-container');
            const passRate = (testSuite.passRate * 100).toFixed(1);
            
            let html = `
                <h3>üìã Test Suite: ${testSuite.name}</h3>
                <div class="test-result ${passRate >= 80 ? 'passed' : passRate >= 60 ? 'warning' : 'failed'}">
                    <strong>Overall Results</strong>
                    <p>Pass Rate: ${passRate}% (${testSuite.summary.passed}/${testSuite.summary.total} tests passed)</p>
                    <p>Duration: ${testSuite.totalDuration}ms</p>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${passRate}%; background: ${passRate >= 80 ? '#28a745' : passRate >= 60 ? '#ffc107' : '#dc3545'};"></div>
                    </div>
                </div>
            `;
            
            // Group tests by category
            const testsByCategory = {};
            testSuite.tests.forEach(test => {
                const category = test.category || 'Other';
                if (!testsByCategory[category]) testsByCategory[category] = [];
                testsByCategory[category].push(test);
            });
            
            Object.entries(testsByCategory).forEach(([category, tests]) => {
                html += `<h4>üìÇ ${category} Tests</h4>`;
                tests.forEach(test => {
                    html += `
                        <div class="test-result ${test.status}">
                            <strong>${test.testName}</strong>
                            <p>${test.details}</p>
                            <small>Duration: ${test.executionTime.toFixed(2)}ms | Category: ${test.category}</small>
                            ${test.errors && test.errors.length > 0 ? `<pre>${test.errors.join('\\n')}</pre>` : ''}
                        </div>
                    `;
                });
            });
            
            container.innerHTML = html;
        }

        function displayTestResults(results, title) {
            const container = document.getElementById('results-container');
            const passed = results.filter(r => r.status === 'passed').length;
            const total = results.length;
            const passRate = total > 0 ? (passed / total * 100).toFixed(1) : 0;
            
            let html = `
                <h3>üìä ${title}</h3>
                <div class="test-result ${passRate >= 80 ? 'passed' : passRate >= 60 ? 'warning' : 'failed'}">
                    <strong>Results Summary</strong>
                    <p>${passed}/${total} tests passed (${passRate}%)</p>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${passRate}%; background: ${passRate >= 80 ? '#28a745' : passRate >= 60 ? '#ffc107' : '#dc3545'};"></div>
                    </div>
                </div>
            `;
            
            results.forEach(result => {
                html += `
                    <div class="test-result ${result.status}">
                        <strong>${result.testName}</strong>
                        <p>${result.details}</p>
                        <small>Duration: ${result.executionTime.toFixed(2)}ms</small>
                        ${result.errors && result.errors.length > 0 ? `<pre>${result.errors.join('\\n')}</pre>` : ''}
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function displayScreenshots(screenshots) {
            const container = document.getElementById('results-container');
            
            let html = `
                <h3>üì∏ Screenshots Captured</h3>
                <p>Captured ${screenshots.length} screenshots at ${new Date().toLocaleTimeString()}</p>
                <div class="screenshot-gallery">
            `;
            
            screenshots.forEach(screenshot => {
                html += `
                    <div class="screenshot-item">
                        <img src="${screenshot.image}" alt="${screenshot.name} Screenshot">
                        <div class="caption">
                            <strong>${screenshot.name}</strong><br>
                            <small>${screenshot.timestamp.toLocaleTimeString()}</small>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        function displayHealthCheck(healthCheck, status) {
            const container = document.getElementById('results-container');
            
            let html = `
                <h3>üîç System Health Check</h3>
                <div class="test-result ${healthCheck.overall === 'healthy' ? 'passed' : healthCheck.overall === 'degraded' ? 'warning' : 'failed'}">
                    <strong>Overall Health: ${healthCheck.overall.toUpperCase()}</strong>
                    <p>System is ${healthCheck.overall === 'healthy' ? 'operating normally' : healthCheck.overall === 'degraded' ? 'experiencing minor issues' : 'experiencing significant issues'}</p>
                </div>
                
                <h4>Component Checks:</h4>
            `;
            
            Object.entries(healthCheck.checks).forEach(([component, passed]) => {
                html += `
                    <div class="test-result ${passed ? 'passed' : 'failed'}">
                        <strong>${component.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase())}</strong>
                        <p>${passed ? 'Working correctly' : 'Issues detected'}</p>
                    </div>
                `;
            });
            
            if (healthCheck.issues && healthCheck.issues.length > 0) {
                html += `
                    <h4>Issues Found:</h4>
                    <div class="test-result failed">
                        <strong>‚ö†Ô∏è Issues</strong>
                        <ul>
                            ${healthCheck.issues.map(issue => `<li>${issue}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }

        function displayTestData(statistics, testSuites, snapshots) {
            const container = document.getElementById('results-container');
            
            let html = `
                <h3>üìä Test Data Overview</h3>
                <div class="test-result passed">
                    <strong>Storage Statistics</strong>
                    <p>Snapshots: ${statistics.snapshots} | Test Results: ${statistics.testResults} | Test Suites: ${statistics.testSuites}</p>
                    <p>Storage Usage: ${statistics.storageUsage} KB</p>
                </div>
            `;
            
            if (testSuites.length > 0) {
                html += `<h4>Recent Test Suites:</h4>`;
                testSuites.slice(-5).forEach(suite => {
                    html += `
                        <div class="test-result ${suite.passRate >= 0.8 ? 'passed' : suite.passRate >= 0.6 ? 'warning' : 'failed'}">
                            <strong>${suite.name}</strong>
                            <p>Pass Rate: ${(suite.passRate * 100).toFixed(1)}% | Tests: ${suite.tests.length} | Duration: ${suite.totalDuration}ms</p>
                            <small>Executed: ${new Date(suite.startTime).toLocaleString()}</small>
                        </div>
                    `;
                });
            }
            
            if (snapshots.length > 0) {
                html += `<h4>Recent Snapshots:</h4>`;
                snapshots.slice(-10).forEach(snapshot => {
                    html += `
                        <div class="test-result warning">
                            <strong>${snapshot.testName}</strong>
                            <p>ID: ${snapshot.id}</p>
                            <small>Created: ${new Date(snapshot.timestamp).toLocaleString()}</small>
                        </div>
                    `;
                });
            }
            
            container.innerHTML = html;
        }

        function displayError(title, error) {
            const container = document.getElementById('results-container');
            container.innerHTML = `
                <div class="test-result failed">
                    <strong>‚ùå ${title}</strong>
                    <p>${error.message || error}</p>
                    ${error.stack ? `<pre>${error.stack}</pre>` : ''}
                </div>
            `;
        }

        async function updateStatusIndicators() {
            try {
                // Check API status
                const apiResponse = await fetch('/health').catch(() => null);
                const apiStatus = document.getElementById('api-status');
                apiStatus.className = `status-indicator ${apiResponse && apiResponse.ok ? 'online' : 'offline'}`;
                
                // Check wallet status
                const walletStatus = document.getElementById('wallet-status');
                const hasWallet = window.keplr || window.leap || window.ethereum;
                walletStatus.className = `status-indicator ${hasWallet ? 'online' : 'offline'}`;
                
                // Check screenshot status
                const screenshotStatus = document.getElementById('screenshot-status');
                const hasScreenshot = window.SeiMoneyTesting && window.SeiMoneyTesting.screenshotCapture;
                screenshotStatus.className = `status-indicator ${hasScreenshot ? 'online' : 'offline'}`;
                
                // Check data management status
                const dataStatus = document.getElementById('data-status');
                const hasDataManager = window.SeiMoneyTesting && window.SeiMoneyTesting.testDataManager;
                dataStatus.className = `status-indicator ${hasDataManager ? 'online' : 'offline'}`;
                
            } catch (error) {
                console.warn('Failed to update status indicators:', error);
            }
        }

        // Update status indicators every 30 seconds
        setInterval(updateStatusIndicators, 30000);

        // Check if testing suite is available
        if (!window.SeiMoneyTesting) {
            document.getElementById('results-container').innerHTML = `
                <div class="test-result failed">
                    <strong>‚ùå Testing Suite Not Available</strong>
                    <p>The SeiMoney testing suite is not loaded. Make sure you're on the SeiMoney application page.</p>
                    <p>You can also try opening the browser console and running tests manually:</p>
                    <pre>
// Available commands:
SeiMoneyTesting.runFullTestSuite()
SeiMoneyTesting.testScreen("home")
SeiMoneyTesting.testIntegration("api")
                    </pre>
                </div>
            `;
        }
    </script>
</body>
</html>